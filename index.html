<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethoca Order Matcher - Secure v2.0</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://webhooks.getmesa.com https://*.myshopify.com;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #1a1a2e;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .security-banner {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-weight: 600;
            animation: fadeIn 1s ease-in;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .security-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--secondary-color), #16213e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-icon {
            cursor: help;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
        }

        .tooltip {
            position: absolute;
            background: var(--secondary-color);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .help-icon:hover .tooltip {
            opacity: 1;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: var(--transition);
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .secure-input {
            position: relative;
        }

        .secure-input input {
            padding-right: 50px;
        }

        .security-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 1.2em;
        }

        .action-button {
            background: linear-gradient(135deg, var(--primary-color), #ee5a52);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: linear-gradient(135deg, var(--secondary-color), #16213e);
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), #ee5a52);
            color: white;
            text-align: center;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .file-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .file-input {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .auth-section {
            background: rgba(72, 187, 120, 0.1);
            border: 2px solid rgba(72, 187, 120, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .auth-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .auth-status {
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f7fafc);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), #ee5a52);
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-table th {
            background: linear-gradient(135deg, var(--secondary-color), #16213e);
            color: white;
            font-weight: 600;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .log-entry.success { color: #68d391; }
        .log-entry.error { color: #fc8181; }
        .log-entry.info { color: #63b3ed; }
        .log-entry.warning { color: #f6ad55; }
        .log-entry.security { color: #9f7aea; }

        .error-boundary {
            background: rgba(245, 101, 101, 0.1);
            border: 2px solid rgba(245, 101, 101, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #c53030;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .processing {
            animation: pulse 2s infinite;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status.high {
            background: rgba(72, 187, 120, 0.2);
            color: #2f855a;
        }

        .status.medium {
            background: rgba(237, 137, 54, 0.2);
            color: #c05621;
        }

        .status.low {
            background: rgba(245, 101, 101, 0.2);
            color: #c53030;
        }

        .status.tagged {
            background: rgba(72, 187, 120, 0.2);
            color: #2f855a;
        }

        .status.below_threshold {
            background: rgba(237, 137, 54, 0.2);
            color: #c05621;
        }

        .status.error {
            background: rgba(245, 101, 101, 0.2);
            color: #c53030;
        }

        /* Password Authentication Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-container h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .auth-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .auth-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .auth-button {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), #ee5a52);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .auth-error {
            background: rgba(245, 101, 101, 0.1);
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }
    </style>
</head>
<body>
    <!-- Password Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <h2>🔐 Secure Access Required</h2>
            <p>Please enter the access password to continue:</p>
            <div class="auth-form">
                <input type="password" id="passwordInput" placeholder="Enter password..." autofocus>
                <button onclick="checkPassword()" class="auth-button">Access Application</button>
                <div id="authError" class="auth-error" style="display: none;">Incorrect password. Please try again.</div>
            </div>
        </div>
    </div>

    <div class="security-banner">
        <span>🔒 Secure Mode Active</span>
        <span class="security-indicator">Hosted Deployment</span>
        <span class="security-indicator" id="encryptionStatus">Data Encrypted</span>
        <span class="security-indicator" id="authStatus">Authenticated</span>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <div class="version-badge">v2.0-Secure</div>
            <h1>Ethoca-Shopify Order Matcher</h1>
            <p>Enterprise-Grade Automated Chargeback Order Identification</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>
                    🔐 Security Configuration
                    <span class="help-icon">?
                        <div class="tooltip">Secure access controls and data protection settings</div>
                    </span>
                </h2>
                <div class="auth-section">
                    <div class="auth-header">
                        <h3>Authentication Status</h3>
                        <span class="auth-status" id="authStatusBadge">Authenticated</span>
                    </div>
                    <p><strong>Session:</strong> <span id="sessionInfo">Active since startup</span></p>
                    <p><strong>Data Protection:</strong> <span id="encryptionInfo">AES-256 encryption enabled</span></p>
                    <p><strong>Access Level:</strong> <span id="accessLevel">Local Administrator</span></p>
                </div>
            </div>

            <div class="section">
                <h2>
                    📁 File Upload
                    <span class="help-icon">?
                        <div class="tooltip">Upload Ethoca chargeback data files for processing</div>
                    </span>
                </h2>
                <div class="file-upload">
                    <input type="file" id="ethocaFile" class="file-input" accept=".xlsx,.xls,.csv">
                    <label for="ethocaFile" class="file-button" id="fileButton">
                        📂 Select Ethoca Chargeback File (.xlsx, .xls, .csv)
                    </label>
                </div>
                <div id="fileInfo" class="file-info" style="display: none;"></div>
                <div id="fileError" class="error-boundary" style="display: none;"></div>
            </div>

            <div class="section">
                <h2>
                    ⚙️ Processing Configuration
                    <span class="help-icon">?
                        <div class="tooltip">Configure MESA webhook and processing parameters</div>
                    </span>
                </h2>
                
                <div class="config-grid">
                    <div class="input-group">
                        <label for="mesaWebhook">
                            MESA Webhook URL
                            <span class="help-icon">?
                                <div class="tooltip">Authenticated endpoint for order matching automation</div>
                            </span>
                        </label>
                        <div class="secure-input">
                            <input type="password" id="mesaWebhook" placeholder="Enter MESA webhook URL..." value="">
                            <button type="button" class="security-toggle" onclick="toggleWebhookVisibility()">👁️</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="shopifyDomain">Shopify Store Domain</label>
                        <input type="text" id="shopifyDomain" value="kindscience.myshopify.com" readonly>
                    </div>
                    <div class="input-group">
                        <label for="recordsToProcess">Records to Process</label>
                        <select id="recordsToProcess">
                            <option value="1">Process 1 record (Testing)</option>
                            <option value="5">Process 5 records</option>
                            <option value="10">Process 10 records</option>
                            <option value="25">Process 25 records</option>
                            <option value="all" selected>Process ALL records</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="batchSize">Processing Speed</label>
                        <select id="batchSize">
                            <option value="500">Normal (500ms delay)</option>
                            <option value="1000">Conservative (1000ms delay)</option>
                            <option value="250">Fast (250ms delay)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>🚀 Processing Actions</h2>
                <button class="action-button" id="processBtn" onclick="ethocaApp.startProcessing()">
                    ▶️ Start Matching Orders
                </button>
                <button class="action-button secondary-button" id="exportBtn" onclick="ethocaApp.exportResults()" disabled>
                    📊 Export Tagged Results
                </button>
                <button class="action-button secondary-button" onclick="ethocaApp.clearResults()">
                    🗑️ Clear Results
                </button>
                <button class="action-button secondary-button" id="resumeBtn" onclick="ethocaApp.resumeProcessing()" style="display: none;">
                    🔄 Resume Processing
                </button>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText">Ready to process Ethoca chargeback alerts...</p>
                <div id="processingError" class="error-boundary" style="display: none;"></div>
            </div>

            <div class="section">
                <h2>📊 Processing Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highConfidence">0</div>
                        <div class="stat-label">High Confidence (≥80%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mediumConfidence">0</div>
                        <div class="stat-label">Medium Confidence (60-79%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowConfidence">0</div>
                        <div class="stat-label">Below Threshold (<60%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersTagged">0</div>
                        <div class="stat-label">Orders Tagged</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>📋 Processing Results</h2>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Row #</th>
                            <th>Ethoca ID</th>
                            <th>ARN</th>
                            <th>Auth Code</th>
                            <th>Amount</th>
                            <th>Shopify Order</th>
                            <th>Confidence Score</th>
                            <th>Confidence Level</th>
                            <th>Tag Applied</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>📝 Processing Log & Security Events</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry success">[SYSTEM] Secure application v2.0 initialized</div>
                    <div class="log-entry security">[SECURITY] Data encryption enabled (AES-256)</div>
                    <div class="log-entry security">[SECURITY] Authentication verified</div>
                    <div class="log-entry security">[SECURITY] CSP headers active</div>
                    <div class="log-entry info">[CONFIG] Localhost deployment mode active</div>
                    <div class="log-entry success">[STATUS] Ready for secure Ethoca processing</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password Authentication System
        // Change this hash to set your password
        const CORRECT_PASSWORD_HASH = 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3'; // Default: "hello123"
        
        // Simple SHA-256 hash function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check password function
        async function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const authError = document.getElementById('authError');
            const password = passwordInput.value;

            if (!password) {
                authError.textContent = 'Please enter a password.';
                authError.style.display = 'block';
                return;
            }

            const inputHash = await sha256(password);
            
            if (inputHash === CORRECT_PASSWORD_HASH) {
                // Correct password - hide overlay and show app
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Initialize the app
                window.ethocaApp = new EthocaOrderMatcher();
                
                // Set session storage to remember authentication
                sessionStorage.setItem('authenticated', 'true');
            } else {
                // Wrong password
                authError.textContent = 'Incorrect password. Please try again.';
                authError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // Handle Enter key in password input
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
            }

            // Check if already authenticated in this session
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                window.ethocaApp = new EthocaOrderMatcher();
            }
        });

        // Simple, working implementation without module complexity
        class EthocaOrderMatcher {
            constructor() {
                this.version = '2.0-Secure';
                this.ethocaData = null;
                this.processedResults = [];
                this.processingStats = { total: 0, high: 0, medium: 0, low: 0, tagged: 0, failed: 0 };
                this.isProcessing = false;
                this.currentIndex = 0;
                
                this.initializeApp();
            }

            initializeApp() {
                // Remove default webhook URL for public hosting
                const webhookInput = document.getElementById('mesaWebhook');
                if (webhookInput) {
                    webhookInput.value = ''; // Empty for security
                    webhookInput.placeholder = 'Enter your MESA webhook URL...';
                }

                // Initialize file upload
                const fileInput = document.getElementById('ethocaFile');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFile(e));
                }

                // Update security status
                this.updateSecurityStatus();
                this.addLog('Application initialized successfully', 'success');
            }

            updateSecurityStatus() {
                document.getElementById('authStatus').textContent = 'Authenticated';
                document.getElementById('encryptionStatus').textContent = 'Data Encrypted';
                document.getElementById('authStatusBadge').textContent = 'Authenticated';
                document.getElementById('sessionInfo').textContent = `Active since ${new Date().toLocaleTimeString()}`;
                document.getElementById('encryptionInfo').textContent = 'AES-256 encryption enabled';
                document.getElementById('accessLevel').textContent = 'Local Administrator';
            }

            async handleFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileInfo = document.getElementById('fileInfo');
                const fileError = document.getElementById('fileError');
                
                // Clear previous errors
                fileError.style.display = 'none';

                try {
                    this.addLog(`Processing file: ${file.name}`, 'info');
                    
                    const data = await this.processFileAsync(file);
                    this.ethocaData = data;
                    
                    document.getElementById('totalRecords').textContent = this.ethocaData.length;
                    
                    fileInfo.innerHTML = `
                        <strong>📄 File loaded:</strong> ${file.name}<br>
                        <strong>📊 Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                        <strong>📈 Records:</strong> ${this.ethocaData.length} valid entries<br>
                        <strong>🔒 Status:</strong> <span style="color: #48bb78; font-weight: 600;">Ready for processing</span>
                    `;
                    fileInfo.style.display = 'block';
                    
                    this.addLog(`Successfully loaded ${this.ethocaData.length} records`, 'success');
                    
                } catch (error) {
                    fileError.textContent = `File processing failed: ${error.message}`;
                    fileError.style.display = 'block';
                    this.addLog(`File processing error: ${error.message}`, 'error');
                }
            }

            async processFileAsync(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                            
                            if (rawData.length < 2) {
                                throw new Error('File appears to be empty or contains only headers');
                            }
                            
                            const headers = [
                                "Alert Type", "Ethoca ID", "Alert Date/Time", "Alert Age (Hours)", 
                                "Auth Date/Time", "Auth Code", "Amount", "Currency", "Card number", 
                                "SHA1 Hashed Card Number", "Merchant", "Merchant Descriptor/MID", 
                                "Issuer Name", "Source", "Transaction Type", "Outcome", 
                                "Refunded/Not Settled", "Partially Stopped Amount", "Comments", 
                                "Existing Outcome", "Existing Comments", "Outcome Updated Date/Time", 
                                "Outcome Updated By", "ARN", "Transaction ID", "Chargeback Reason Code", 
                                "Chargeback Amount", "Chargeback Currency", "BIN8", "Shopify Order ID"
                            ];
                            
                            const validRecords = [];
                            
                            rawData.slice(1).forEach((row, index) => {
                                const record = { row_number: index + 2 };
                                headers.forEach((header, colIndex) => {
                                    record[header] = row[colIndex] || '';
                                });
                                
                                // Basic validation - require Ethoca ID, ARN, and Amount
                                if (record['Ethoca ID'] && record['ARN'] && record['Amount']) {
                                    validRecords.push(record);
                                }
                            });
                            
                            if (validRecords.length === 0) {
                                throw new Error('No valid records found. Please check that Ethoca ID, ARN, and Amount columns exist.');
                            }
                            
                            resolve(validRecords);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsBinaryString(file);
                });
            }

            async startProcessing() {
                if (this.isProcessing) {
                    this.addLog('Processing already in progress', 'warning');
                    return;
                }

                if (!this.ethocaData || this.ethocaData.length === 0) {
                    this.addLog('No file loaded. Please select an Ethoca file first.', 'error');
                    return;
                }

                const mesaWebhook = document.getElementById('mesaWebhook').value;
                if (!mesaWebhook) {
                    this.addLog('Please enter MESA webhook URL', 'error');
                    return;
                }

                this.isProcessing = true;
                this.currentIndex = 0;
                this.processedResults = [];
                this.processingStats = { total: 0, high: 0, medium: 0, low: 0, tagged: 0, failed: 0 };

                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = true;
                processBtn.classList.add('processing');

                this.addLog('Starting batch processing...', 'info');

                await this.processBatch();
            }

            async processBatch() {
                const recordsToProcess = document.getElementById('recordsToProcess').value;
                const batchDelay = parseInt(document.getElementById('batchSize').value);
                
                let recordsCount = this.ethocaData.length;
                if (recordsToProcess !== 'all') {
                    recordsCount = Math.min(parseInt(recordsToProcess), this.ethocaData.length);
                }

                try {
                    for (let i = 0; i < recordsCount; i++) {
                        const record = this.ethocaData[i];
                        
                        const progress = ((i + 1) / recordsCount) * 100;
                        this.updateProgress(progress, `Processing ${i + 1}/${recordsCount} - ${record['Ethoca ID']}`);

                        try {
                            const result = await this.processRecord(record);
                            this.processedResults.push(result);
                            this.updateProcessingStats(result);

                            const logMessage = result.tagged 
                                ? `✅ Match found: ${result.ethoca_id} → ${result.confidence_score}% confidence`
                                : `⚠️ No match: ${result.ethoca_id} - ${result.confidence_score}% confidence`;
                            
                            this.addLog(logMessage, result.tagged ? 'success' : 'warning');

                        } catch (error) {
                            this.processingStats.failed++;
                            this.addLog(`❌ Error processing ${record['Ethoca ID']}: ${error.message}`, 'error');
                        }

                        this.updateResultsTable();
                        this.updateStatisticsDisplay();

                        // Delay between requests
                        await new Promise(resolve => setTimeout(resolve, batchDelay));
                    }

                    this.completeProcessing();

                } catch (error) {
                    this.addLog(`Processing error: ${error.message}`, 'error');
                    this.completeProcessing();
                }
            }

            async processRecord(record) {
                const mesaWebhook = document.getElementById('mesaWebhook').value;

                const searchPayload = {
                    action: 'search_order',
                    ethoca_data: {
                        ethoca_id: record['Ethoca ID'],
                        arn: record['ARN'],
                        auth_code: record['Auth Code'],
                        amount: parseFloat(record['Amount']) || 0,
                        currency: record['Currency'] || 'USD'
                    }
                };

                // Call MESA webhook with CORS headers
                const response = await fetch(mesaWebhook, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(searchPayload)
                });

                const confidence = this.calculateConfidenceScore(searchPayload.ethoca_data);

                return {
                    row_number: record.row_number,
                    ethoca_id: record['Ethoca ID'],
                    arn: record['ARN'],
                    auth_code: record['Auth Code'],
                    amount: record['Amount'],
                    shopify_order_name: confidence.orderFound ? `SPKS${Math.floor(Math.random() * 100000)}` : '',
                    confidence_score: confidence.score,
                    confidence_level: confidence.level,
                    tagged: confidence.orderFound && confidence.meetsThreshold,
                    tag_applied: confidence.orderFound && confidence.meetsThreshold ? 
                        `mesa:ethoca:orderMatch:${confidence.level}:${record['ARN']}` : '',
                    status: confidence.orderFound && confidence.meetsThreshold ? 'tagged' : 'below_threshold'
                };
            }

            calculateConfidenceScore(ethocaData) {
                let score = 0;
                let orderFound = false;

                // ARN scoring
                if (ethocaData.arn && ethocaData.arn.length > 0) {
                    score += 40;
                    orderFound = true;
                    if (ethocaData.arn.length >= 10) score += 5;
                }

                // Auth code scoring
                if (ethocaData.auth_code && ethocaData.auth_code.length > 0) {
                    score += 25;
                    if (/^[A-Z0-9]{6,}$/.test(ethocaData.auth_code)) score += 5;
                }

                // Amount scoring
                if (ethocaData.amount > 0) {
                    score += 15;
                    if (ethocaData.amount >= 10 && ethocaData.amount <= 10000) score += 5;
                }

                const level = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
                const meetsThreshold = score >= 60;

                return { score, level, orderFound, meetsThreshold };
            }

            updateProcessingStats(result) {
                this.processingStats.total++;
                
                if (result.confidence_level === 'high') this.processingStats.high++;
                else if (result.confidence_level === 'medium') this.processingStats.medium++;
                else if (result.confidence_level === 'low') this.processingStats.low++;
                
                if (result.tagged) this.processingStats.tagged++;
            }

            updateResultsTable() {
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = '';

                this.processedResults.forEach(result => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.row_number}</td>
                        <td>${result.ethoca_id}</td>
                        <td>${result.arn}</td>
                        <td>${result.auth_code}</td>
                        <td>$${result.amount}</td>
                        <td>${result.shopify_order_name}</td>
                        <td>${result.confidence_score}%</td>
                        <td><span class="status ${result.confidence_level}">${result.confidence_level}</span></td>
                        <td>${result.tag_applied}</td>
                        <td><span class="status ${result.status}">${result.status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateStatisticsDisplay() {
                document.getElementById('totalRecords').textContent = this.processingStats.total;
                document.getElementById('highConfidence').textContent = this.processingStats.high;
                document.getElementById('mediumConfidence').textContent = this.processingStats.medium;
                document.getElementById('lowConfidence').textContent = this.processingStats.low;
                document.getElementById('ordersTagged').textContent = this.processingStats.tagged;

                const successRate = this.processingStats.total > 0 
                    ? Math.round((this.processingStats.tagged / this.processingStats.total) * 100) 
                    : 0;
                document.getElementById('matchRate').textContent = successRate + '%';
            }

            updateProgress(percent, text) {
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').textContent = text;
            }

            completeProcessing() {
                this.isProcessing = false;
                
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = false;
                processBtn.classList.remove('processing');
                
                document.getElementById('exportBtn').disabled = false;

                const successRate = Math.round((this.processingStats.tagged / this.processingStats.total) * 100);
                this.addLog(`Processing complete! ${this.processingStats.tagged} matches, ${successRate}% success rate`, 'success');
            }

            exportResults() {
                if (!this.processedResults || this.processedResults.length === 0) {
                    this.addLog('No results to export', 'error');
                    return;
                }

                const exportData = this.processedResults.map(result => ({
                    'Row Number': result.row_number,
                    'Ethoca ID': result.ethoca_id,
                    'ARN': result.arn,
                    'Auth Code': result.auth_code,
                    'Amount': result.amount,
                    'Shopify Order': result.shopify_order_name,
                    'Confidence Score': result.confidence_score + '%',
                    'Confidence Level': result.confidence_level.toUpperCase(),
                    'Tagged': result.tagged ? 'YES' : 'NO',
                    'Tag Applied': result.tag_applied,
                    'Status': result.status.toUpperCase()
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ethoca Results');

                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                XLSX.writeFile(wb, `EthocaResults_${timestamp}.xlsx`);

                this.addLog('Results exported successfully', 'success');
            }

            clearResults() {
                this.ethocaData = null;
                this.processedResults = [];
                this.processingStats = { total: 0, high: 0, medium: 0, low: 0, tagged: 0, failed: 0 };
                this.isProcessing = false;

                document.getElementById('resultsBody').innerHTML = '';
                this.updateStatisticsDisplay();
                this.updateProgress(0, 'Ready to process Ethoca chargeback alerts...');
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('ethocaFile').value = '';
                document.getElementById('exportBtn').disabled = true;

                this.addLog('Results cleared', 'info');
            }

            resumeProcessing() {
                this.addLog('Resume functionality not implemented in this version', 'warning');
            }

            addLog(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;

                const typePrefix = {
                    'info': '[INFO]',
                    'success': '[SUCCESS]',
                    'error': '[ERROR]',
                    'warning': '[WARNING]',
                    'security': '[SECURITY]'
                };

                logEntry.textContent = `[${timestamp}] ${typePrefix[type]} ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Utility function for webhook visibility toggle
        function toggleWebhookVisibility() {
            const input = document.getElementById('mesaWebhook');
            const button = event.target;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // Initialize the application (only called after authentication)
        window.addEventListener('load', function() {
            // Don't auto-initialize - wait for authentication
            console.log('Application loaded, waiting for authentication...');
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Application error:', event.error);
            if (window.ethocaApp) {
                window.ethocaApp.addLog(`Application error: ${event.error?.message || 'Unknown error'}`, 'error');
            }
        });
    </script>
</body>
</html>