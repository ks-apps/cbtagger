<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethoca Order Matcher</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .file-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .config-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-button {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(72, 187, 120, 0.4);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .secondary-button:hover:not(:disabled) {
            box-shadow: 0 12px 25px rgba(237, 137, 54, 0.4);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-table th {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            font-weight: 600;
        }

        .results-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status.matched {
            background: rgba(72, 187, 120, 0.2);
            color: #2f855a;
        }

        .status.pending {
            background: rgba(237, 137, 54, 0.2);
            color: #c05621;
        }

        .status.failed {
            background: rgba(245, 101, 101, 0.2);
            color: #c53030;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .processing {
            animation: pulse 2s infinite;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f7fafc);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ethoca Order Matcher</h1>
            <p>Automated chargeback order identification system</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="section">
                <h2>üìÅ Load Ethoca File</h2>
                <div class="file-upload">
                    <input type="file" id="ethocaFile" class="file-input" accept=".xlsx,.xls,.csv">
                    <label for="ethocaFile" class="file-button">
                        üìÇ Select Ethoca Chargeback File
                    </label>
                </div>
                <div id="fileInfo" class="file-info" style="display: none;"></div>
            </div>

            <!-- Configuration Section -->
            <div class="section">
                <h2>‚öôÔ∏è MESA Configuration</h2>
                <div class="config-section">
                    <div class="input-group">
                        <label for="mesaWebhook">MESA Web Request URL</label>
                        <input type="url" id="mesaWebhook" value="https://webhooks.getmesa.com/v1/kindscience/webrequest/68d23d6c8e8576d228006322/68fe36c5b7.json?apikey=TNlzaM8sPt4TaCATVB9jz8ZObd5Q7HEC5e782u2U">
                    </div>
                    <div class="input-group">
                        <label for="recordCount">Number of Records to Process</label>
                        <select id="recordCount">
                            <option value="1">1 record (testing)</option>
                            <option value="5">5 records</option>
                            <option value="10">10 records</option>
                            <option value="20">20 records</option>
                            <option value="all" selected>All records</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="section">
                <h2>üöÄ Processing Actions</h2>
                <button class="action-button" id="processBtn" onclick="processFile()">
                    ‚ñ∂Ô∏è Start Matching Orders
                </button>
                <button class="action-button secondary-button" id="exportBtn" onclick="exportResults()" disabled>
                    üíæ Export Tagged Results
                </button>
                <button class="action-button secondary-button" onclick="clearResults()">
                    üóëÔ∏è Clear Results
                </button>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText">Ready to process...</p>
            </div>

            <!-- Statistics -->
            <div class="section">
                <h2>üìä Processing Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchedRecords">0</div>
                        <div class="stat-label">Matched Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="failedRecords">0</div>
                        <div class="stat-label">Failed Matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="section">
                <h2>üìã Processing Results</h2>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Ethoca ID</th>
                            <th>ARN</th>
                            <th>Auth Code</th>
                            <th>Amount</th>
                            <th>Shopify Order</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <!-- Processing Log -->
            <div class="section">
                <h2>üìù Processing Log</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">System ready. Upload Ethoca file to begin...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ethocaData = [];
        let processedResults = [];
        
        // File handling
        document.getElementById('ethocaFile').addEventListener('change', handleFile);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <strong>üìÑ File loaded:</strong> ${file.name}<br>
                <strong>üìä Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                <strong>üóìÔ∏è Modified:</strong> ${new Date(file.lastModified).toLocaleString()}
            `;
            fileInfo.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                    
                    // Parse Ethoca data structure
                    const headers = rawData[0];
                    
                    ethocaData = rawData.slice(1).map((row, index) => {
                        const record = { row_number: index + 2 };
                        headers.forEach((header, colIndex) => {
                            record[header] = row[colIndex] || '';
                        });
                        return record;
                    });
                    
                    document.getElementById('totalRecords').textContent = ethocaData.length;
                    addLog(`Loaded ${ethocaData.length} chargeback records from ${file.name}`, 'success');
                    
                } catch (error) {
                    addLog(`Error reading file: ${error.message}`, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }
        
        // Processing function
        async function processFile() {
            if (ethocaData.length === 0) {
                addLog('No file loaded. Please select an Ethoca file first.', 'error');
                return;
            }
            
            const mesaWebhook = document.getElementById('mesaWebhook').value;
            
            if (!mesaWebhook) {
                addLog('Please fill in MESA webhook URL.', 'error');
                return;
            }
            
            const recordCountSelect = document.getElementById('recordCount').value;
            const recordsToProcess = recordCountSelect === 'all' ? 
                ethocaData.length : 
                Math.min(parseInt(recordCountSelect), ethocaData.length);
            
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.classList.add('processing');
            
            processedResults = [];
            let matched = 0, failed = 0;
            
            addLog(`Starting batch processing of ${recordsToProcess} records...`, 'info');
            
            for (let i = 0; i < recordsToProcess; i++) {
                const record = ethocaData[i];
                
                // Update progress
                const progress = ((i + 1) / recordsToProcess) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Processing record ${i + 1} of ${recordsToProcess} - ${record['Ethoca ID']}`;
                
                try {
                    const result = await processRecord(record, mesaWebhook);
                    processedResults.push(result);
                    
                    if (result.success && result.matched) {
                        matched++;
                        addLog(`‚úÖ Match found: ${result.ethoca_id} ‚Üí Order ${result.order_name || result.shopify_order}`, 'success');
                    } else {
                        failed++;
                        addLog(`‚ùå No match: ${result.ethoca_id} - ${result.message || result.error || 'Unknown error'}`, 'error');
                    }
                    
                    updateResultsTable();
                    updateStatistics(matched, failed);
                    
                    // Small delay to prevent API rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    failed++;
                    addLog(`‚ùå Processing error for ${record['Ethoca ID']}: ${error.message}`, 'error');
                    
                    processedResults.push({
                        ethoca_id: record['Ethoca ID'],
                        arn: record['ARN'],
                        auth_code: record['Auth Code'],
                        amount: record['Amount'],
                        shopify_order: '',
                        confidence: 0,
                        status: 'failed',
                        error: error.message
                    });
                }
            }
            
            processBtn.disabled = false;
            processBtn.classList.remove('processing');
            document.getElementById('exportBtn').disabled = false;
            
            addLog(`Processing complete! ${matched} matches, ${failed} failures.`, 'success');
        }
        
        // Process individual record - FIXED VERSION
        async function processRecord(record, mesaWebhook) {
            const searchPayload = {
                ethoca_data: {
                    ethoca_id: record['Ethoca ID'],
                    arn: record['ARN'],
                    auth_code: record['Auth Code'],
                    amount: parseFloat(record['Amount']),
                    currency: record['Currency'],
                    auth_date: record['Auth Date/Time'],
                    alert_date: record['Alert Date/Time'],
                    transaction_id: record['Transaction ID'],
                    issuer: record['Issuer Name'],
                    card_last4: record['Card number']?.slice(-4),
                    card_iin: record['BIN8']
                }
            };
            
            console.log('Sending to MESA:', JSON.stringify(searchPayload));
            
            try {
                const response = await fetch(mesaWebhook, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(searchPayload)
                });
                
                console.log('MESA response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`MESA returned status ${response.status}: ${response.statusText}`);
                }
                
                // FIXED: Use .json() instead of .text() + JSON.parse()
                const result = await response.json();
                console.log('MESA parsed result:', result);
                
                return result;
                
            } catch (error) {
                console.error('MESA request error:', error);
                
                // Return a structured error response instead of throwing
                return {
                    success: false,
                    matched: false,
                    error: error.message,
                    ethoca_id: record['Ethoca ID']
                };
            }
        }
        
        // Update results table
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            processedResults.forEach(result => {
                const row = document.createElement('tr');
                const status = result.success && result.matched ? 'matched' : 'failed';
                
                row.innerHTML = `
                    <td>${result.ethoca_id || 'N/A'}</td>
                    <td>${result.arn || 'N/A'}</td>
                    <td>${result.auth_code || 'N/A'}</td>
                    <td>$${result.amount || '0'}</td>
                    <td>${result.order_name || result.shopify_order || 'N/A'}</td>
                    <td>${result.confidence || 0}%</td>
                    <td><span class="status ${status}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update statistics
        function updateStatistics(matched, failed) {
            const total = matched + failed;
            const rate = total > 0 ? Math.round((matched / total) * 100) : 0;
            
            document.getElementById('matchedRecords').textContent = matched;
            document.getElementById('failedRecords').textContent = failed;
            document.getElementById('matchRate').textContent = rate + '%';
        }
        
        // Export results to Excel
        function exportResults() {
            if (processedResults.length === 0) {
                addLog('No results to export.', 'error');
                return;
            }
            
            const exportData = processedResults.map(result => ({
                'Ethoca ID': result.ethoca_id || 'N/A',
                'ARN': result.arn || 'N/A',
                'Auth Code': result.auth_code || 'N/A',
                'Amount': result.amount || 0,
                'Shopify Order': result.order_name || result.shopify_order || 'N/A',
                'Order ID': result.order_id || 'N/A',
                'Confidence': result.confidence || 0,
                'Confidence Level': result.confidence_level || 'N/A',
                'Status': result.success && result.matched ? 'Matched' : 'Failed',
                'Message': result.message || result.error || 'N/A',
                'Tag Applied': result.tag_applied || 'N/A',
                'Timestamp': result.timestamp || new Date().toISOString()
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ethoca Results');
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            XLSX.writeFile(wb, `EthocaMatched_${timestamp}.xlsx`);
            
            addLog('Results exported successfully!', 'success');
        }
        
        // Clear all results
        function clearResults() {
            processedResults = [];
            ethocaData = [];
            document.getElementById('resultsBody').innerHTML = '';
            document.getElementById('totalRecords').textContent = '0';
            document.getElementById('matchedRecords').textContent = '0';
            document.getElementById('failedRecords').textContent = '0';
            document.getElementById('matchRate').textContent = '0%';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Ready to process...';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('ethocaFile').value = '';
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry info">System cleared. Upload new file to begin...</div>';
        }
        
        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>
