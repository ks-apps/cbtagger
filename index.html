<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethoca-Shopify Order Matcher</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .file-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-button {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(72, 187, 120, 0.4);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .secondary-button:hover:not(:disabled) {
            box-shadow: 0 12px 25px rgba(237, 137, 54, 0.4);
        }

        .danger-button {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .results-table th {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            font-weight: 600;
        }

        .results-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status.matched {
            background: rgba(72, 187, 120, 0.2);
            color: #2f855a;
        }

        .status.processing {
            background: rgba(237, 137, 54, 0.2);
            color: #c05621;
        }

        .status.failed {
            background: rgba(245, 101, 101, 0.2);
            color: #c53030;
        }

        .status.pending {
            background: rgba(160, 174, 192, 0.2);
            color: #4a5568;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .log-entry.warning {
            color: #f6ad55;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f7fafc);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .processing-row {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { background: rgba(102, 126, 234, 0.05); }
            50% { background: rgba(102, 126, 234, 0.15); }
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Ethoca-Shopify Order Matcher</h1>
            <p>Automated chargeback order identification and tagging system</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="section">
                <h2>üìÅ Step 1: Load Ethoca File</h2>
                <div class="file-upload">
                    <input type="file" id="ethocaFile" class="file-input" accept=".xlsx,.xls,.csv">
                    <label for="ethocaFile" class="file-button">
                        üìÇ Select Ethoca Chargeback File (.xlsx or .csv)
                    </label>
                </div>
                <div id="fileInfo" class="file-info" style="display: none;"></div>
            </div>

            <!-- Configuration Section -->
            <div class="section">
                <h2>‚öôÔ∏è Step 2: Configure MESA Web Request</h2>
                <div class="input-group">
                    <label for="mesaWebhook">MESA Web Request URL</label>
                    <input type="url" id="mesaWebhook" 
                           placeholder="https://webhooks.getmesa.com/v1/kindscience/webrequest/..."
                           value="https://webhooks.getmesa.com/v1/kindscience/webrequest/68fd0cacdb7be454c4073397/68fd0d1aad0774dd400758e9.json?apikey=TNlzaM8sPt4TaCATVB9jz8ZObd5Q7HEC5e782u2U">
                </div>
                
                <div class="config-section">
                    <div class="input-group">
                        <label for="recordLimit">Number of Records to Process</label>
                        <select id="recordLimit">
                            <option value="1">1 (Test)</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="all">All Records</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="processingDelay">Delay Between Records (ms)</label>
                        <input type="number" id="processingDelay" value="500" min="100" max="5000" step="100">
                    </div>
                </div>

                <button class="action-button secondary-button" onclick="validateWebhookConnection()">
                    üîó Test Connection
                </button>
            </div>

            <!-- Processing Controls -->
            <div class="section">
                <h2>üöÄ Step 3: Process Orders</h2>
                <div class="control-group">
                    <button class="action-button" id="processBtn" onclick="processFile()" disabled>
                        ‚ñ∂Ô∏è Start Matching Orders
                    </button>
                    <button class="action-button secondary-button" id="pauseBtn" onclick="pauseProcessing()" disabled>
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="action-button danger-button" onclick="clearResults()">
                        üóëÔ∏è Clear All
                    </button>
                    <span class="status-indicator" id="processingStatus">No file loaded</span>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <p id="progressText">Ready to process Ethoca file...</p>
            </div>

            <!-- Statistics -->
            <div class="section">
                <h2>üìä Processing Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="processedRecords">0</div>
                        <div class="stat-label">Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchedRecords">0</div>
                        <div class="stat-label">Matched</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="failedRecords">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="section">
                <h2>üìã Processing Results</h2>
                <button class="action-button secondary-button" id="exportBtn" onclick="exportResults()" disabled>
                    üíæ Export Results to Excel
                </button>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Row #</th>
                            <th>Ethoca ID</th>
                            <th>ARN</th>
                            <th>Auth Code</th>
                            <th>Amount</th>
                            <th>Shopify Order</th>
                            <th>Tag Applied</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <!-- Processing Log -->
            <div class="section">
                <h2>üìù Processing Log</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">System ready. Upload Ethoca file to begin...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ethocaData = [];
        let processedResults = [];
        let isProcessing = false;
        let isPaused = false;
        let currentProcessIndex = 0;
        
        // File handling
        document.getElementById('ethocaFile').addEventListener('change', handleFile);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <strong>üìÑ File loaded:</strong> ${file.name}<br>
                <strong>üìä Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                <strong>üóìÔ∏è Modified:</strong> ${new Date(file.lastModified).toLocaleString()}
            `;
            fileInfo.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                    
                    // Parse Ethoca data structure
                    const headers = rawData[0];
                    ethocaData = rawData.slice(1).map((row, index) => {
                        const record = { row_number: index + 2 };
                        headers.forEach((header, colIndex) => {
                            record[header] = row[colIndex] || '';
                        });
                        return record;
                    });
                    
                    document.getElementById('totalRecords').textContent = ethocaData.length;
                    document.getElementById('processBtn').disabled = false;
                    addLog(`‚úÖ Loaded ${ethocaData.length} chargeback records from ${file.name}`, 'success');
                    updateProcessingStatus();
                    
                } catch (error) {
                    addLog(`‚ùå Error reading file: ${error.message}`, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }
        
        // Main processing function
        async function processFile() {
            if (ethocaData.length === 0) {
                addLog('‚ùå No file loaded. Please select an Ethoca file first.', 'error');
                return;
            }
            
            const mesaWebhook = document.getElementById('mesaWebhook').value.trim();
            if (!mesaWebhook) {
                addLog('‚ùå Please enter MESA Web Request URL', 'error');
                return;
            }
            
            isProcessing = true;
            isPaused = false;
            updateUI(true);
            
            const recordLimit = document.getElementById('recordLimit').value;
            const recordsToProcess = recordLimit === 'all' ? ethocaData.length : Math.min(parseInt(recordLimit), ethocaData.length);
            const delay = parseInt(document.getElementById('processingDelay').value);
            
            addLog(`üöÄ Starting batch processing of ${recordsToProcess} records...`, 'info');
            
            let matched = 0, failed = 0;
            
            for (let i = currentProcessIndex; i < recordsToProcess; i++) {
                if (!isProcessing) {
                    addLog('‚èπÔ∏è Processing stopped by user', 'warning');
                    break;
                }
                
                while (isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                currentProcessIndex = i;
                const record = ethocaData[i];
                
                // Update progress
                const progress = ((i + 1) / recordsToProcess) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Processing record ${i + 1} of ${recordsToProcess} - ${record['Ethoca ID']}`;
                
                updateRowStatus(i, 'processing');
                
                try {
                    const result = await processRecord(record, mesaWebhook);
                    processedResults.push(result);
                    
                    if (result.status === 'matched') {
                        matched++;
                        addLog(`‚úÖ Match found: ${result.ethoca_id} ‚Üí Order ${result.shopify_order_name}`, 'success');
                    } else {
                        failed++;
                        addLog(`‚ùå No match: ${result.ethoca_id} - ${result.error || 'No matching order found'}`, 'error');
                    }
                    
                    updateRowStatus(i, result.status);
                    updateResultsTable();
                    updateStatistics(matched, failed, i + 1);
                    
                    // Delay between records
                    if (i < recordsToProcess - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                } catch (error) {
                    failed++;
                    addLog(`‚ùå Processing error for ${record['Ethoca ID']}: ${error.message}`, 'error');
                    
                    processedResults.push({
                        row_number: record.row_number,
                        ethoca_id: record['Ethoca ID'],
                        arn: record['Transaction ID'] || record['ARN'],
                        auth_code: record['Auth Code'],
                        amount: record['Amount'],
                        shopify_order_name: '',
                        tag_applied: '',
                        confidence: 0,
                        status: 'failed',
                        error: error.message
                    });
                    
                    updateRowStatus(i, 'failed');
                    updateResultsTable();
                    updateStatistics(matched, failed, i + 1);
                }
            }
            
            isProcessing = false;
            currentProcessIndex = 0;
            updateUI(false);
            
            addLog(`‚úÖ Processing complete! ${matched} matches, ${failed} failures.`, 'success');
            updateProcessingStatus();
        }
        
        // UPDATED: Process individual record using Web Request API
        async function processRecord(record, mesaWebRequestUrl) {
            // Prepare payload for MESA Web Request
            const payload = {
                ethoca_data: {
                    ethoca_id: record['Ethoca ID'],
                    arn: record['Transaction ID'] || record['ARN'],
                    auth_code: record['Auth Code'],
                    amount: parseFloat(record['Amount']) || 0,
                    currency: record['Currency'],
                    auth_date: record['Auth Date/Time'],
                    alert_date: record['Alert Date/Time'],
                    transaction_id: record['Transaction ID'],
                    issuer: record['Issuer Name'],
                    card_last4: String(record['Card number'] || '').slice(-4),
                    card_iin: String(record['BIN8'] || '').substring(0, 6)
                }
            };
            
            console.log('Sending to MESA:', JSON.stringify(payload, null, 2));
            
            // CHANGED: Direct call to MESA Web Request endpoint (no proxy needed)
            const response = await fetch(mesaWebRequestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            console.log('MESA response status:', response.status, response.statusText);
            
            // Get response text first to see what we're getting
            const responseText = await response.text();
            console.log('MESA response text:', responseText);
            
            if (!response.ok) {
                throw new Error(`MESA API error: ${response.status} ${response.statusText} - ${responseText}`);
            }
            
            // Try to parse as JSON
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('MESA parsed result:', JSON.stringify(result, null, 2));
            } catch (e) {
                throw new Error(`Invalid JSON response from MESA: ${responseText}`);
            }
            
            // CHANGED: Use actual response data from MESA
            return {
                row_number: record.row_number,
                ethoca_id: record['Ethoca ID'],
                arn: record['Transaction ID'] || record['ARN'],
                auth_code: record['Auth Code'],
                amount: record['Amount'],
                shopify_order_name: result.order_name || '',
                tag_applied: result.tag_applied || '',
                confidence: result.confidence || 0,
                status: result.matched ? 'matched' : 'failed',
                error: result.error || ''
            };
        }
        
        // Pause/Resume functionality
        function pauseProcessing() {
            if (!isProcessing) return;
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.innerHTML = '‚ñ∂Ô∏è Resume';
                addLog('‚è∏Ô∏è Processing paused', 'warning');
            } else {
                pauseBtn.innerHTML = '‚è∏Ô∏è Pause';
                addLog('‚ñ∂Ô∏è Processing resumed', 'info');
            }
        }
        
        // UI update functions
        function updateUI(processing) {
            document.getElementById('processBtn').disabled = processing;
            document.getElementById('pauseBtn').disabled = !processing;
            document.getElementById('exportBtn').disabled = processedResults.length === 0;
        }
        
        function updateRowStatus(index, status) {
            const tableBody = document.getElementById('resultsBody');
            while (tableBody.children.length <= index) {
                const record = ethocaData[index];
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${record.row_number}</td>
                    <td>${record['Ethoca ID']}</td>
                    <td>${record['ARN']}</td>
                    <td>${record['Auth Code']}</td>
                    <td>$${record['Amount']}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td><span class="status pending">pending</span></td>
                `;
            }
            
            const row = tableBody.children[index];
            const statusCell = row.cells[8];
            statusCell.innerHTML = `<span class="status ${status}">${status}</span>`;
            
            if (status === 'processing') {
                row.classList.add('processing-row');
            } else {
                row.classList.remove('processing-row');
            }
        }
        
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            
            processedResults.forEach((result, index) => {
                if (tbody.children[index]) {
                    const row = tbody.children[index];
                    row.cells[5].textContent = result.shopify_order_name || '-';
                    row.cells[6].textContent = result.tag_applied || '-';
                    row.cells[7].textContent = result.confidence + '%';
                }
            });
        }
        
        function updateStatistics(matched, failed, processed) {
            const total = matched + failed;
            const rate = total > 0 ? Math.round((matched / total) * 100) : 0;
            
            document.getElementById('processedRecords').textContent = processed;
            document.getElementById('matchedRecords').textContent = matched;
            document.getElementById('failedRecords').textContent = failed;
            document.getElementById('matchRate').textContent = rate + '%';
        }
        
        // Export results to Excel
        function exportResults() {
            if (processedResults.length === 0) {
                addLog('‚ùå No results to export', 'error');
                return;
            }
            
            try {
                // Create enhanced dataset for export
                const exportData = ethocaData.map((record, index) => {
                    const result = processedResults.find(r => r.row_number === record.row_number) || {};
                    
                    return {
                        'Row Number': record.row_number,
                        'Ethoca ID': record['Ethoca ID'],
                        'Alert Date/Time': record['Alert Date/Time'],
                        'ARN': record['ARN'],
                        'Auth Code': record['Auth Code'],
                        'Amount': record['Amount'],
                        'Currency': record['Currency'],
                        'Issuer Name': record['Issuer Name'],
                        'Transaction ID': record['Transaction ID'],
                        'Processing Status': result.status || 'not processed',
                        'Shopify Order': result.shopify_order_name || '',
                        'Tag Applied': result.tag_applied || '',
                        'Match Confidence': result.confidence || 0,
                        'Error Details': result.error || '',
                        'Processed Date': new Date().toISOString().split('T')[0],
                        'Processing Time': new Date().toLocaleTimeString()
                    };
                });
                
                // Convert to worksheet and export
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ethoca Processing Results');
                
                // Export file with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `EthocaProcessingResults_${timestamp}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                addLog(`üíæ Results exported to ${filename}`, 'success');
                addLog(`üìä Exported ${exportData.length} records with processing status`, 'info');
                
            } catch (error) {
                addLog(`‚ùå Export failed: ${error.message}`, 'error');
            }
        }
        
        function clearResults() {
            if (isProcessing) {
                if (!confirm('Processing is currently running. Are you sure you want to stop and clear all results?')) {
                    return;
                }
                isProcessing = false;
            }
            
            // Reset all data
            processedResults = [];
            ethocaData = [];
            currentProcessIndex = 0;
            isPaused = false;
            
            // Reset UI elements
            document.getElementById('resultsBody').innerHTML = '';
            document.getElementById('totalRecords').textContent = '0';
            document.getElementById('processedRecords').textContent = '0';
            document.getElementById('matchedRecords').textContent = '0';
            document.getElementById('failedRecords').textContent = '0';
            document.getElementById('matchRate').textContent = '0%';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Ready to process Ethoca file...';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('ethocaFile').value = '';
            
            // Reset button states
            updateUI(false);
            document.getElementById('pauseBtn').innerHTML = '‚è∏Ô∏è Pause';
            
            // Clear log except for startup message
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry info">System cleared. Upload new Ethoca file to begin...</div>';
                
            addLog('üóëÔ∏è All results and data cleared', 'info');
            updateProcessingStatus();
        }
        
        // Update processing status display
        function updateProcessingStatus() {
            const statusElement = document.getElementById('processingStatus');
            if (!ethocaData.length) {
                statusElement.textContent = 'No file loaded';
                statusElement.style.color = '#a0aec0';
                return;
            }
            
            const recordLimit = document.getElementById('recordLimit').value;
            const recordsToProcess = recordLimit === 'all' ? ethocaData.length : Math.min(parseInt(recordLimit), ethocaData.length);
            
            if (isProcessing) {
                statusElement.textContent = `Processing ${currentProcessIndex + 1}/${recordsToProcess}...`;
                statusElement.style.color = '#ed8936';
            } else if (processedResults.length > 0) {
                statusElement.textContent = `Processed ${processedResults.length}/${recordsToProcess} records`;
                statusElement.style.color = '#38a169';
            } else {
                statusElement.textContent = `Ready to process ${recordsToProcess} records`;
                statusElement.style.color = '#667eea';
            }
        }
        
        // Logging function
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            // Add appropriate emoji based on type
            const emoji = {
                'success': '‚úÖ',
                'error': '‚ùå', 
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            logEntry.textContent = `[${timestamp}] ${emoji[type] || ''} ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep log size manageable (last 100 entries)
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // Advanced features
        function validateWebhookConnection() {
            const webhook = document.getElementById('mesaWebhook').value.trim();
            if (!webhook) {
                addLog('‚ùå No Web Request URL configured', 'error');
                return;
            }
            
            addLog('üîó Testing MESA Web Request connection...', 'info');
            
            fetch(webhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ethoca_data: {
                        ethoca_id: 'TEST_CONNECTION',
                        arn: '000000000000000',
                        amount: 0
                    }
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                addLog('‚úÖ MESA Web Request connection successful', 'success');
                addLog(`üì° Response received: ${JSON.stringify(data)}`, 'info');
            })
            .catch(error => {
                addLog(`‚ùå Connection failed: ${error.message}`, 'error');
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to start processing
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!isProcessing && ethocaData.length > 0) {
                    processFile();
                }
            }
            
            // Space to pause/resume
            if (e.key === ' ' && isProcessing) {
                e.preventDefault();
                pauseProcessing();
            }
            
            // Escape to clear
            if (e.key === 'Escape' && !isProcessing) {
                clearResults();
            }
        });
        
        // Visibility change handling (pause when window loses focus)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isProcessing && !isPaused) {
                addLog('üëÅÔ∏è Window hidden - consider pausing to prevent issues', 'warning');
            }
        });
        
        // Error handling for uncaught errors
        window.addEventListener('error', function(e) {
            addLog(`üí• Unexpected error: ${e.message}`, 'error');
            console.error('Uncaught error:', e);
        });
        
        // Network status monitoring
        window.addEventListener('online', function() {
            addLog('üåê Network connection restored', 'success');
        });
        
        window.addEventListener('offline', function() {
            addLog('üìµ Network connection lost - processing may fail', 'warning');
            if (isProcessing) {
                pauseProcessing();
            }
        });
        
        // Final initialization
        addLog('‚ö° Ethoca-Shopify Order Matcher ready (Web Request API)', 'success');
        addLog('üí° Tip: Use Ctrl+Enter to start, Space to pause, Escape to clear', 'info');
    </script>
</body>
</html>
